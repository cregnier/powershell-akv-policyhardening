**********************
PowerShell transcript start
Start time: 20260126104023
Username: DTL01\lcladmin
RunAs User: DTL01\lcladmin
Configuration Name: 
Machine: DTL01 (Microsoft Windows NT 10.0.20348.0)
Host Application: C:\Program Files\PowerShell\7\pwsh.dll -noexit -command try { . "c:\Program Files\Microsoft VS Code\resources\app\out\vs\workbench\contrib\terminal\common\scripts\shellIntegration.ps1" } catch {}
Process ID: 10412
PSVersion: 7.5.3
PSEdition: Core
GitCommitId: 7.5.3
OS: Microsoft Windows 10.0.20348
Platform: Win32NT
PSCompatibleVersions: 1.0, 2.0, 3.0, 4.0, 5.0, 5.1, 6.0, 7.0
PSRemotingProtocolVersion: 2.3
SerializationVersion: 1.1.0.1
WSManStackVersion: 3.0
**********************
Transcript started, output file is .\logs\Phase1-Infrastructure-Setup-20260126.log
]633;D;0]633;A]633;P;Cwd=C:\x5cSource\x5cpowershell-akv-policyhardeningPS C:\Source\powershell-akv-policyhardening> ]633;B
PS>Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan; Write-Host "â•‘         PHASE 1: FRESH INFRASTRUCTURE SETUP                  â•‘" -ForegroundColor Cyan; Write-Host "â•‘         Master Test Execution - January 26, 2026             â•‘" -ForegroundColor Cyan; Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor Cyan; Write-Host "Creating complete testing infrastructure..." -ForegroundColor Yellow; Write-Host "This will create:" -ForegroundColor White; Write-Host "  1. rg-policy-remediation (managed identity, networking)" -ForegroundColor Gray; Write-Host "  2. rg-policy-keyvault-test (3 test vaults)" -ForegroundColor Gray; Write-Host "  3. Log Analytics + Event Hub" -ForegroundColor Gray; Write-Host "  4. Monitoring alerts (skipped for now)`n" -ForegroundColor Gray; Write-Host "Expected Duration: 15-20 minutes`n" -ForegroundColor Cyan

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         PHASE 1: FRESH INFRASTRUCTURE SETUP                  â•‘
â•‘         Master Test Execution - January 26, 2026             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Creating complete testing infrastructure...
This will create:
  1. rg-policy-remediation (managed identity, networking)
  2. rg-policy-keyvault-test (3 test vaults)
  3. Log Analytics + Event Hub
  4. Monitoring alerts (skipped for now)
Expected Duration: 15-20 minutes
]633;D;0]633;A]633;P;Cwd=C:\x5cSource\x5cpowershell-akv-policyhardeningPS C:\Source\powershell-akv-policyhardening> ]633;B
PS>.\Setup-AzureKeyVaultPolicyEnvironment.ps1 -SkipMonitoring

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                              â•‘
â•‘          AZURE KEY VAULT POLICY ENVIRONMENT SETUP                            â•‘
â•‘          Comprehensive Infrastructure + Testing + Monitoring                 â•‘
â•‘                                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“‹ Configuration:
  Environment: DevTest
  Subscription: Current context
  Test RG: rg-policy-keyvault-test
  Infra RG: rg-policy-remediation
  Location: eastus
  Cleanup First: False
  Skip Vault Seeding: False
  Skip Monitoring: True

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  [1/12] Azure Authentication
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ“
Using current context: MSDN Platforms Subscription
  â„¹
Scope: /subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb
  â„¹
Signed in as: theregniers_hotmail.com#EXT#@theregniershotmail.onmicrosoft.com

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  [2/12] Resource Groups
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ“
Using existing: rg-policy-remediation
  âœ“
Using existing: rg-policy-keyvault-test

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  [3/12] Managed Identity for Policy Remediation
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ“
Using existing: id-policy-remediation
  â„¹
Principal ID: e46e333b-18a2-4166-a071-87b26ad3a9d9
  â„¹
Assigning RBAC roles to managed identity...
  âœ“
Role already assigned: Network Contributor
  âœ“
Role already assigned: Private DNS Zone Contributor
  âœ“
Role already assigned: Log Analytics Contributor
  âœ“
Role already assigned: Contributor

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  [4/12] Virtual Network and Subnet
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ“
Using existing VNet: vnet-policy-test
  âœ“
Using existing Subnet: snet-privateendpoints
  â„¹
Subnet ID: /subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/resourceGroups/rg-policy-remediation/providers/Microsoft.Network/virtualNetworks/vnet-policy-test/subnets/snet-privateendpoints

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  [5/12] Private DNS Zone
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ“
Using existing: privatelink.vaultcore.azure.net
  âœ“
VNet already linked to DNS zone
  â„¹
DNS Zone ID: /subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/resourceGroups/rg-policy-remediation/providers/Microsoft.Network/privateDnsZones/privatelink.vaultcore.azure.net

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  [6/12] Log Analytics Workspace
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ“
Using existing Log Analytics Workspace: law-policy-test-2524
  â„¹
Workspace ID: /subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/resourceGroups/rg-policy-remediation/providers/Microsoft.OperationalInsights/workspaces/law-policy-test-2524

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  [7/12] Event Hub Namespace
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PS>TerminatingError(): "The pipeline has been stopped."
  âœ“
Using existing Event Hub Namespace: eh-policy-test-2254
  âœ“
Using existing Event Hub: keyvault-diagnostics
  â„¹
Auth Rule ID: /subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/resourceGroups/rg-policy-remediation/providers/Microsoft.EventHub/namespaces/eh-policy-test-2254/authorizationrules/RootManageSharedAccessKey
  â„¹
Skipping monitoring setup (as requested)

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  [8/12] Test Key Vaults Creation
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  â„¹
Creating Key Vault: kv-compliant-9487...
  âœ“
Created: kv-compliant-9487 (Fully compliant vault)
  â„¹
Creating Key Vault: kv-partial-3147...
  âœ“
Created: kv-partial-3147 (Partially compliant vault)
  â„¹
Creating Key Vault: kv-noncompliant-8891...
  âœ“
Created: kv-noncompliant-8891 (Non-compliant vault (for testing blocking))

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  [9/12] RBAC Role Assignments
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  â„¹
Assigning 'Key Vault Administrator' role to current user...
  âœ“
Assigned role for: kv-compliant-9487
  âœ“
Assigned role for: kv-partial-3147
  âœ“
Assigned access policy for: kv-noncompliant-8891
  â„¹
Waiting 60 seconds for RBAC propagation...

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  [10/12] Seeding Test Data (Secrets, Keys, Certificates)
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  â„¹
Detecting client IP address...
  âœ“
Client IP: 20.10.50.180
  â„¹
Temporarily enabling public access for kv-compliant-9487 to seed test data...
  âœ“
Public access enabled
  â„¹
Temporarily adding client IP to firewall for kv-compliant-9487 (allows data seeding from current client)...
  âœ“
Firewall rule added
  â„¹
Seeding data in: kv-compliant-9487...
  âœ“
Created 4 secrets in kv-compliant-9487
  âœ“
Created 5 keys in kv-compliant-9487
  âœ“
Created 3 certificates in kv-compliant-9487
  â„¹
Removing temporary firewall rule from kv-compliant-9487 (restores original security posture)...
  âœ“
Firewall rule removed
  â„¹
Restoring public access to 'Disabled' for kv-compliant-9487...
  âœ“
Public access restored to original setting
  â„¹
Temporarily adding client IP to firewall for kv-partial-3147 (allows data seeding from current client)...
  âœ“
Firewall rule added
  â„¹
Seeding data in: kv-partial-3147...
  âœ“
Created 4 secrets in kv-partial-3147
  âœ“
Created 5 keys in kv-partial-3147
  âœ“
Created 3 certificates in kv-partial-3147
  â„¹
Removing temporary firewall rule from kv-partial-3147 (restores original security posture)...
  âœ“
Firewall rule removed
  â„¹
Temporarily adding client IP to firewall for kv-noncompliant-8891 (allows data seeding from current client)...
  âœ“
Firewall rule added
  â„¹
Seeding data in: kv-noncompliant-8891...
  âœ“
Created 4 secrets in kv-noncompliant-8891
  âœ“
Created 5 keys in kv-noncompliant-8891
  âœ“
Created 3 certificates in kv-noncompliant-8891
  â„¹
Removing temporary firewall rule from kv-noncompliant-8891 (restores original security posture)...
  âœ“
Firewall rule removed

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  [11/12] Configuration Files Update
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ“
Updated: PolicyParameters.json (reference only - not used for deployment)
  âœ“
Updated: PolicyImplementationConfig.json (reference only - not used for deployment)

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                              â•‘
â•‘                          âœ… SETUP COMPLETE                                   â•‘
â•‘                                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“Š Summary:

  Infrastructure Created:
    âœ“ Managed Identity: id-policy-remediation
    âœ“ VNet: vnet-policy-test
    âœ“ Subnet: snet-privateendpoints
    âœ“ Private DNS Zone: privatelink.vaultcore.azure.net
    âœ“ Log Analytics Workspace: law-policy-test-2524
    âœ“ Event Hub Namespace: eh-policy-test-2254

  Test Environment:
    âœ“ Created 3 Key Vaults
    âœ“ Seeded test data:
      - Secrets: 12
      - Keys: 15
      - Certificates: 9

  Configuration Files:
    âœ“ PolicyParameters.json (reference - infrastructure IDs)
    âœ“ PolicyImplementationConfig.json (reference - environment details)
    â„¹ï¸  NOTE: Main script uses PolicyParameters-*.json files for deployment

ðŸ“‹ Next Steps:
  1. Deploy 46 policies: .\\AzPolicyImplScript.ps1 -Environment DevTest -Phase Test
  2. Check compliance: .\\AzPolicyImplScript.ps1 -CheckCompliance -TriggerScan -SkipRBACCheck
  3. Deploy to Production Audit: .\\AzPolicyImplScript.ps1 -Environment Production -Phase Audit
  4. Enable enforcement: .\\AzPolicyImplScript.ps1 -Environment Production -Phase Enforce

âœ¨ Environment is ready for policy deployment and testing!
]633;D;0]633;A]633;P;Cwd=C:\x5cSource\x5cpowershell-akv-policyhardeningPS C:\Source\powershell-akv-policyhardening> ]633;B
PS>Stop-Transcript; Write-Host "`nâœ… PHASE 1 COMPLETE!" -ForegroundColor Green; Write-Host "`nInfrastructure Created:" -ForegroundColor Cyan; Write-Host "  âœ“ 2 Resource Groups (rg-policy-remediation, rg-policy-keyvault-test)" -ForegroundColor Gray; Write-Host "  âœ“ Managed Identity (id-policy-remediation) with RBAC roles" -ForegroundColor Gray; Write-Host "  âœ“ Networking (VNet, Subnet, Private DNS)" -ForegroundColor Gray; Write-Host "  âœ“ Monitoring (Log Analytics, Event Hub)" -ForegroundColor Gray; Write-Host "  âœ“ 3 Test Vaults (compliant/partial/non-compliant)" -ForegroundColor Gray; Write-Host "  âœ“ Test Data (12 secrets, 15 keys, 9 certificates)" -ForegroundColor Gray; Write-Host "`nVaults Created:" -ForegroundColor Cyan; Get-AzKeyVault -ResourceGroupName "rg-policy-keyvault-test" | Select-Object VaultName, EnablePurgeProtection, EnableRbacAuthorization, PublicNetworkAccess | Format-Table -AutoSize
**********************
PowerShell transcript end
End time: 20260126104518
**********************
