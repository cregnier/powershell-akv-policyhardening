**********************
PowerShell transcript start
Start time: 20260127115451
Username: DTL01\lcladmin
RunAs User: DTL01\lcladmin
Configuration Name: 
Machine: DTL01 (Microsoft Windows NT 10.0.20348.0)
Host Application: C:\Program Files\PowerShell\7\pwsh.dll -noexit -command try { . "c:\Program Files\Microsoft VS Code\resources\app\out\vs\workbench\contrib\terminal\common\scripts\shellIntegration.ps1" } catch {}
Process ID: 7012
PSVersion: 7.5.3
PSEdition: Core
GitCommitId: 7.5.3
OS: Microsoft Windows 10.0.20348
Platform: Win32NT
PSCompatibleVersions: 1.0, 2.0, 3.0, 4.0, 5.0, 5.1, 6.0, 7.0
PSRemotingProtocolVersion: 2.3
SerializationVersion: 1.1.0.1
WSManStackVersion: 3.0
**********************
Transcript started, output file is .\logs\Scenario6-Enhanced-Validation-20260127-115451.log
]633;D;0]633;A]633;P;Cwd=C:\x5cSource\x5cpowershell-akv-policyhardeningPS C:\Source\powershell-akv-policyhardening> ]633;B
PS>Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan; Write-Host "â•‘  SCENARIO 6: ENHANCED COMPREHENSIVE VALIDATION              â•‘" -ForegroundColor Cyan; Write-Host "â•‘  NEW: VNet + Premium Vault + Cert Lifetime Actions Testing  â•‘" -ForegroundColor Cyan; Write-Host "â•‘  Expected: 26 PASS, 0 FAIL, 7 SKIP (was 23/0/11)            â•‘" -ForegroundColor Cyan; Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor Cyan; .\AzPolicyImplScript.ps1 -TestAllDenyPolicies

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  SCENARIO 6: ENHANCED COMPREHENSIVE VALIDATION              â•‘
â•‘  NEW: VNet + Premium Vault + Cert Lifetime Actions Testing  â•‘
â•‘  Expected: 26 PASS, 0 FAIL, 7 SKIP (was 23/0/11)            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Azure Policy Implementation - Key Vault Governance          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[2026-01-27 11:55:01Z]
[INFO]
Starting Azure Policy implementation script for Key Vault policies
[2026-01-27 11:55:01Z]
[INFO]
Checking required PowerShell modules...
[2026-01-27 11:55:01Z]
[SUCCESS]
Module Az.Accounts is present
[2026-01-27 11:55:01Z]
[SUCCESS]
Module Az.Resources is present
[2026-01-27 11:55:01Z]
[SUCCESS]
Module Az.PolicyInsights is present
[2026-01-27 11:55:01Z]
[SUCCESS]
Module Az.Monitor is present
[2026-01-27 11:55:01Z]
[SUCCESS]
Module Az.KeyVault is present
[2026-01-27 11:55:01Z]
[INFO]
Using Azure context: theregniers@hotmail.com
[2026-01-27 11:55:01Z]
[INFO]
Running comprehensive validation of ALL 34 Deny policies...

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   COMPREHENSIVE DENY POLICY VALIDATION - ALL 34 POLICIES (100% COVERAGE)   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Using Resource Group: rg-policy-keyvault-test
Using Location: eastus

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  PHASE 1: VAULT-LEVEL POLICIES (6 tests)                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[1] Soft Delete Required (CRITICAL)
  Attempting to create vault WITHOUT soft delete via ARM...
PS>TerminatingError(New-AzResourceGroupDeployment): "The running command stopped because the preference variable "ErrorActionPreference" or common parameter is set to Stop: 11:55:02 AM - Error: Code=InvalidTemplateDeployment; Message=The template deployment failed because of policy violation. Please see details for more information.
"
  âœ… PASS: Blocked by policy

[2] Purge Protection Required (CRITICAL)
  Attempting to create vault WITHOUT purge protection...
PS>TerminatingError(New-AzKeyVault): "The running command stopped because the preference variable "ErrorActionPreference" or common parameter is set to Stop: Resource 'val-nopurge-2912' was disallowed by policy. Policy identifiers: '[{"policyAssignment":{"name":"AzureKeyVaultshoulddisablepublicnetworkaccess-188399946","id":"/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/providers/Microsoft.Authorization/policyAssignments/AzureKeyVaultshoulddisablepublicnetworkaccess-188399946"},"policyDefinition":{"name":"Azure Key Vault should disable public network access","id":"/providers/Microsoft.Authorization/policyDefinitions/405c5871-3e91-4644-8a63-58e19d68ff5b","version":"1.1.0"}},{"policyAssignment":{"name":"Keyvaultsshouldhavesoftdeleteenabled-716191913","id":"/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/providers/Microsoft.Authorization/policyAssignments/Keyvaultsshouldhavesoftdeleteenabled-716191913"},"policyDefinition":{"name":"Key vaults should have soft delete enabled","id":"/providers/Microsoft.Authorization/policyDefinitions/1e66c121-a66a-4b1f-9b83-0fd99bf0fc2d","version":"3.1.0"}},{"policyAssignment":{"name":"AzureKeyVaultshouldhavefirewallenabledorpublicnetworka-571915124","id":"/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/providers/Microsoft.Authorization/policyAssignments/AzureKeyVaultshouldhavefirewallenabledorpublicnetworka-571915124"},"policyDefinition":{"name":"Azure Key Vault should have firewall enabled or public network access disabled","id":"/providers/Microsoft.Authorization/policyDefinitions/55615ac9-af46-4a59-874e-391cc3dfb490","version":"3.3.0"}},{"policyAssignment":{"name":"Keyvaultsshouldhavedeletionprotectionenabled-1084075278","id":"/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/providers/Microsoft.Authorization/policyAssignments/Keyvaultsshouldhavedeletionprotectionenabled-1084075278"},"policyDefinition":{"name":"Key vaults should have deletion protection enabled","id":"/providers/Microsoft.Authorization/policyDefinitions/0b60c0b2-2dc2-4e1c-b5c9-abbed971de53","version":"2.1.0"}}]'."
  âœ… PASS: Blocked by policy

[3] Public Network Access Disabled (HIGH)
  Attempting to create vault WITH public access enabled...
PS>TerminatingError(New-AzKeyVault): "The running command stopped because the preference variable "ErrorActionPreference" or common parameter is set to Stop: Resource 'val-public-5327' was disallowed by policy. Policy identifiers: '[{"policyAssignment":{"name":"AzureKeyVaultshoulddisablepublicnetworkaccess-188399946","id":"/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/providers/Microsoft.Authorization/policyAssignments/AzureKeyVaultshoulddisablepublicnetworkaccess-188399946"},"policyDefinition":{"name":"Azure Key Vault should disable public network access","id":"/providers/Microsoft.Authorization/policyDefinitions/405c5871-3e91-4644-8a63-58e19d68ff5b","version":"1.1.0"}},{"policyAssignment":{"name":"Keyvaultsshouldhavesoftdeleteenabled-716191913","id":"/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/providers/Microsoft.Authorization/policyAssignments/Keyvaultsshouldhavesoftdeleteenabled-716191913"},"policyDefinition":{"name":"Key vaults should have soft delete enabled","id":"/providers/Microsoft.Authorization/policyDefinitions/1e66c121-a66a-4b1f-9b83-0fd99bf0fc2d","version":"3.1.0"}},{"policyAssignment":{"name":"AzureKeyVaultshouldhavefirewallenabledorpublicnetworka-571915124","id":"/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/providers/Microsoft.Authorization/policyAssignments/AzureKeyVaultshouldhavefirewallenabledorpublicnetworka-571915124"},"policyDefinition":{"name":"Azure Key Vault should have firewall enabled or public network access disabled","id":"/providers/Microsoft.Authorization/policyDefinitions/55615ac9-af46-4a59-874e-391cc3dfb490","version":"3.3.0"}}]'."
  âœ… PASS: Blocked by policy

[4] Firewall Required (HIGH)
  Attempting to create vault without firewall...
PS>TerminatingError(New-AzKeyVault): "The running command stopped because the preference variable "ErrorActionPreference" or common parameter is set to Stop: Resource 'val-nofw-1292' was disallowed by policy. Policy identifiers: '[{"policyAssignment":{"name":"AzureKeyVaultshoulddisablepublicnetworkaccess-188399946","id":"/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/providers/Microsoft.Authorization/policyAssignments/AzureKeyVaultshoulddisablepublicnetworkaccess-188399946"},"policyDefinition":{"name":"Azure Key Vault should disable public network access","id":"/providers/Microsoft.Authorization/policyDefinitions/405c5871-3e91-4644-8a63-58e19d68ff5b","version":"1.1.0"}},{"policyAssignment":{"name":"Keyvaultsshouldhavesoftdeleteenabled-716191913","id":"/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/providers/Microsoft.Authorization/policyAssignments/Keyvaultsshouldhavesoftdeleteenabled-716191913"},"policyDefinition":{"name":"Key vaults should have soft delete enabled","id":"/providers/Microsoft.Authorization/policyDefinitions/1e66c121-a66a-4b1f-9b83-0fd99bf0fc2d","version":"3.1.0"}},{"policyAssignment":{"name":"AzureKeyVaultshouldhavefirewallenabledorpublicnetworka-571915124","id":"/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/providers/Microsoft.Authorization/policyAssignments/AzureKeyVaultshouldhavefirewallenabledorpublicnetworka-571915124"},"policyDefinition":{"name":"Azure Key Vault should have firewall enabled or public network access disabled","id":"/providers/Microsoft.Authorization/policyDefinitions/55615ac9-af46-4a59-874e-391cc3dfb490","version":"3.3.0"}}]'."
  âœ… PASS: Blocked by policy

[5] RBAC Required (HIGH)
  Attempting to create vault with Access Policies...
PS>TerminatingError(New-AzKeyVault): "The running command stopped because the preference variable "ErrorActionPreference" or common parameter is set to Stop: Resource 'val-accesspol-2326' was disallowed by policy. Policy identifiers: '[{"policyAssignment":{"name":"AzureKeyVaultshoulddisablepublicnetworkaccess-188399946","id":"/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/providers/Microsoft.Authorization/policyAssignments/AzureKeyVaultshoulddisablepublicnetworkaccess-188399946"},"policyDefinition":{"name":"Azure Key Vault should disable public network access","id":"/providers/Microsoft.Authorization/policyDefinitions/405c5871-3e91-4644-8a63-58e19d68ff5b","version":"1.1.0"}},{"policyAssignment":{"name":"Keyvaultsshouldhavesoftdeleteenabled-716191913","id":"/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/providers/Microsoft.Authorization/policyAssignments/Keyvaultsshouldhavesoftdeleteenabled-716191913"},"policyDefinition":{"name":"Key vaults should have soft delete enabled","id":"/providers/Microsoft.Authorization/policyDefinitions/1e66c121-a66a-4b1f-9b83-0fd99bf0fc2d","version":"3.1.0"}},{"policyAssignment":{"name":"AzureKeyVaultshoulduseRBACpermissionmodel-1502415944","id":"/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/providers/Microsoft.Authorization/policyAssignments/AzureKeyVaultshoulduseRBACpermissionmodel-1502415944"},"policyDefinition":{"name":"Azure Key Vault should use RBAC permission model","id":"/providers/Microsoft.Authorization/policyDefinitions/12d4fa5e-1f9f-4c21-97a9-b99b3c6611b5","version":"1.0.1"}},{"policyAssignment":{"name":"AzureKeyVaultshouldhavefirewallenabledorpublicnetworka-571915124","id":"/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/providers/Microsoft.Authorization/policyAssignments/AzureKeyVaultshouldhavefirewallenabledorpublicnetworka-571915124"},"policyDefinition":{"name":"Azure Key Vault should have firewall enabled or public network access disabled","id":"/providers/Microsoft.Authorization/policyDefinitions/55615ac9-af46-4a59-874e-391cc3dfb490","version":"3.3.0"}}]'."
  âœ… PASS: Blocked by policy

[6] Private Link Required (HIGH)
  Deploying VNet infrastructure for private link testing...
  Creating VNet: vnet-policy-test-3344...
  âœ… VNet created: vnet-policy-test-3344
  Attempting to create vault WITHOUT private endpoint...
PS>TerminatingError(New-AzKeyVault): "A parameter cannot be found that matches parameter name 'EnableRbacAuthorization'."
  âš ï¸ WARN: Non-policy error - A parameter cannot be found that matches parameter...
  ðŸ§¹ Cleaning up VNet: vnet-policy-test-3344...

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Creating compliant baseline vault for resource tests...      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Creating new baseline vault with PUBLIC access...
PS>TerminatingError(New-AzResourceGroupDeployment): "The running command stopped because the preference variable "ErrorActionPreference" or common parameter is set to Stop: 11:55:23 AM - Error: Code=InvalidTemplateDeployment; Message=The template deployment failed because of policy violation. Please see details for more information.
"
  âŒ FAILED to create baseline vault: 11:55:23 AM - Error: Code=InvalidTemplateDeployment; Message=The template deployment failed because of policy violation. Please see details for more information.
  âš ï¸  Skipping resource-level tests

ðŸ“„ Results saved to: AllDenyPoliciesValidation-20260127-115523.csv

[2026-01-27 11:55:23Z]
[SUCCESS]
Comprehensive Deny policy validation completed.
]633;D;0]633;A]633;P;Cwd=C:\x5cSource\x5cpowershell-akv-policyhardeningPS C:\Source\powershell-akv-policyhardening> ]633;B
PS>Stop-Transcript
**********************
PowerShell transcript end
End time: 20260127115533
**********************
